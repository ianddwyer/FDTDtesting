%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Update loops for the auxiliary variables and superimposing the
% updated auxiliary variables into the electric field:
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% lower x-pml region (XMinus):
if(npmlx_1 > 0)
     q_hy_xz_1(1:npmlx_1,1:ny-1,1:nz-1)=...
    b_hyz_xz_1(1:npmlx_1,1:ny-1,1:nz-1).*q_hy_xz_1(1:npmlx_1,1:ny-1,1:nz-1)+...
     c_hy_xz_1(1:npmlx_1,1:ny-1,1:nz-1).*...
           (ez(2:npmlx_1+1,1:ny-1,1:nz-1)-ez(1:npmlx_1,1:ny-1,1:nz-1));
       
     q_hz_xy_1(1:npmlx_1,1:ny-1,1:nz-1) =...
    b_hyz_xz_1(1:npmlx_1,1:ny-1,1:nz-1).*q_hz_xy_1(1:npmlx_1,1:ny-1,1:nz-1)+...
     c_hz_xy_1(1:npmlx_1,1:ny-1,1:nz-1).*...
           (ey(2:npmlx_1+1,1:ny-1,1:nz-1)-ey(1:npmlx_1,1:ny-1,1:nz-1));
       
    hy(1:npmlx_1,1:ny-1,1:nz-1) = hy(1:npmlx_1,1:ny-1,1:nz-1)+...
     q_hy_xz_1(1:npmlx_1,1:ny-1,1:nz-1);
 
    hz(1:npmlx_1,1:ny-1,1:nz-1) = hz(1:npmlx_1,1:ny-1,1:nz-1)-...
     q_hz_xy_1(1:npmlx_1,1:ny-1,1:nz-1);
end

% upper x-pml region (XPlus):
if(npmlx_2 > 0)
    ns = nx - npmlx_2;
    q_hy_xz_2(1:npmlx_2,1:ny-1,1:nz-1)=...
    b_hyz_xz_2(1:npmlx_2,1:ny-1,1:nz-1).*q_hy_xz_2(1:npmlx_2,1:ny-1,1:nz-1)+...
     c_hy_xz_2(1:npmlx_2,1:ny-1,1:nz-1).*...
           (ez(ns+1:nx,1:ny-1,1:nz-1)-ez(ns:nx-1,1:ny-1,1:nz-1));
       
    q_hz_xy_2(1:npmlx_2,1:ny-1,1:nz-1) =...
    b_hyz_xz_2(1:npmlx_2,1:ny-1,1:nz-1).*q_hz_xy_2(1:npmlx_2,1:ny-1,1:nz-1)+...
     c_hz_xy_2(1:npmlx_2,1:ny-1,1:nz-1).*...
           (ey(ns+1:nx,1:ny-1,1:nz-1)-ey(ns:nx-1,1:ny-1,1:nz-1));
       
    hy(ns:nx-1,1:ny-1,1:nz-1) = hy(ns:nx-1,1:ny-1,1:nz-1)+...
     q_hy_xz_2(1:npmlx_2,1:ny-1,1:nz-1);
 
    hz(ns:nx-1,1:ny-1,1:nz-1) = hz(ns:nx-1,1:ny-1,1:nz-1)-...
     q_hz_xy_2(1:npmlx_2,1:ny-1,1:nz-1);
end


% lower y-pml region (YMinus):
if(npmly_1 > 0)
     q_hz_yx_1(1:nx-1,1:npmly_1,1:nz-1)=...
    b_hzx_yx_1(1:nx-1,1:npmly_1,1:nz-1).*q_hz_yx_1(1:nx-1,1:npmly_1,1:nz-1)+...
     c_hz_yx_1(1:nx-1,1:npmly_1,1:nz-1).*...
           (ex(1:nx-1,2:npmly_1+1,1:nz-1)-ex(1:nx-1,1:npmly_1,1:nz-1));
       
     q_hx_yz_1(1:nx-1,1:npmly_1,1:nz-1) =...
    b_hzx_yx_1(1:nx-1,1:npmly_1,1:nz-1).*q_hx_yz_1(1:nx-1,1:npmly_1,1:nz-1)+...
     c_hx_yz_1(1:nx-1,1:npmly_1,1:nz-1).*...
           (ez(1:nx-1,2:npmly_1+1,1:nz-1)-ez(1:nx-1,1:npmly_1,1:nz-1));
       
    hz(1:nx-1,1:npmly_1,1:nz-1) = hz(1:nx-1,1:npmly_1,1:nz-1)+...
     q_hz_yx_1(1:nx-1,1:npmly_1,1:nz-1);
 
    hx(1:nx-1,1:npmly_1,1:nz-1) = hx(1:nx-1,1:npmly_1,1:nz-1)-...
     q_hx_yz_1(1:nx-1,1:npmly_1,1:nz-1);
end

% upper y-pml region (YPlus):
if(npmly_2 > 0)
    ns = ny - npmly_2;
     q_hz_yx_2(1:nx-1,1:npmly_2,1:nz-1)=...
    b_hzx_yx_2(1:nx-1,1:npmly_2,1:nz-1).*q_hz_yx_2(1:nx-1,1:npmly_2,1:nz-1)+...
     c_hz_yx_2(1:nx-1,1:npmly_2,1:nz-1).*...
           (ex(1:nx-1,ns+1:ny,1:nz-1)-ex(1:nx-1,ns:ny-1,1:nz-1));
       
     q_hx_yz_2(1:nx-1,1:npmly_2,1:nz-1)=...
    b_hzx_yx_2(1:nx-1,1:npmly_2,1:nz-1).*q_hx_yz_2(1:nx-1,1:npmly_2,1:nz-1)+...
     c_hx_yz_2(1:nx-1,1:npmly_2,1:nz-1).*...
           (ez(1:nx-1,ns+1:ny,1:nz-1)-ez(1:nx-1,ns:ny-1,1:nz-1));
       
    hz(1:nx-1,ns:ny-1,1:nz-1) = hz(1:nx-1,ns:ny-1,1:nz-1)+...
     q_hz_yx_2(1:nx-1,1:npmly_2,1:nz-1);
 
    hx(1:nx-1,ns:ny-1,1:nz-1) = hx(1:nx-1,ns:ny-1,1:nz-1)-...
     q_hx_yz_2(1:nx-1,1:npmly_2,1:nz-1);
end


% lower z-pml region (ZMinus):
if(npmlz_1 > 0)
     q_hx_zy_1(1:nx-1,1:ny-1,1:npmlz_1)=...
    b_hxy_zy_1(1:nx-1,1:ny-1,1:npmlz_1).*q_hx_zy_1(1:nx-1,1:ny-1,1:npmlz_1)+...
     c_hx_zy_1(1:nx-1,1:ny-1,1:npmlz_1).*...
           (ey(1:nx-1,1:ny-1,2:npmlz_1+1)-ey(1:nx-1,1:ny-1,1:npmlz_1));
       
     q_hy_zx_1(1:nx-1,1:ny-1,1:npmlz_1) =...
    b_hxy_zy_1(1:nx-1,1:ny-1,1:npmlz_1).*q_hy_zx_1(1:nx-1,1:ny-1,1:npmlz_1)+...
     c_hy_zx_1(1:nx-1,1:ny-1,1:npmlz_1).*...
           (ex(1:nx-1,1:ny-1,2:npmlz_1+1)-ex(1:nx-1,1:ny-1,1:npmlz_1));
       
    hx(1:nx-1,1:ny-1,1:npmlz_1) = hx(1:nx-1,1:ny-1,1:npmlz_1)+...
     q_hx_zy_1(1:nx-1,1:ny-1,1:npmlz_1);
 
    hy(1:nx-1,1:ny-1,1:npmlz_1) = hy(1:nx-1,1:ny-1,1:npmlz_1)-...
     q_hy_zx_1(1:nx-1,1:ny-1,1:npmlz_1);
end

% upper z-pml region (ZPlus):
if(npmlz_2 > 0)
    ns = nz - npmlz_2;
     q_hx_zy_2(1:nx-1,1:ny-1,1:npmlz_2)=...
    b_hxy_zy_2(1:nx-1,1:ny-1,1:npmlz_2).*q_hx_zy_2(1:nx-1,1:ny-1,1:npmlz_2)+...
     c_hx_zy_2(1:nx-1,1:ny-1,1:npmlz_2).*...
           (ey(1:nx-1,1:ny-1,ns+1:nz)-ey(1:nx-1,1:ny-1,ns:nz-1));
       
     q_hy_zx_2(1:nx-1,1:ny-1,1:npmlz_2)=...
    b_hxy_zy_2(1:nx-1,1:ny-1,1:npmlz_2).*q_hy_zx_2(1:nx-1,1:ny-1,1:npmlz_2)+...
     c_hy_zx_2(1:nx-1,1:ny-1,1:npmlz_2).*...
           (ex(1:nx-1,1:ny-1,ns+1:nz)-ex(1:nx-1,1:ny-1,ns:nz-1));
       
    hx(1:nx-1,1:ny-1,ns:nz-1) = hx(1:nx-1,1:ny-1,ns:nz-1)+...
     q_hx_zy_2(1:nx-1,1:ny-1,1:npmlz_2);
 
    hy(1:nx-1,1:ny-1,ns:nz-1) = hy(1:nx-1,1:ny-1,ns:nz-1)-...
     q_hy_zx_2(1:nx-1,1:ny-1,1:npmlz_2);
end
