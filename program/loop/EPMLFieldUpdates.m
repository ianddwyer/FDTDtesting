%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Update loops for the auxiliary variables and superimposing the
% updated auxiliary variables into the electric field:
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% lower x-pml region (XMinus):
if(npmlx_1 > 0)
     q_ey_xz_1(2:npmlx_1+1,1:ny-1,1:nz-1)=...
    b_eyz_xz_1(2:npmlx_1+1,1:ny-1,1:nz-1).*q_ey_xz_1(2:npmlx_1+1,1:ny-1,1:nz-1)+...
     c_ey_xz_1(2:npmlx_1+1,1:ny-1,1:nz-1).*...
           (hz(2:npmlx_1+1,1:ny-1,1:nz-1)-hz(1:npmlx_1,1:ny-1,1:nz-1));
       
     q_ez_xy_1(2:npmlx_1+1,1:ny-1,1:nz-1) =...
    b_eyz_xz_1(2:npmlx_1+1,1:ny-1,1:nz-1).*q_ez_xy_1(2:npmlx_1+1,1:ny-1,1:nz-1)+...
     c_ez_xy_1(2:npmlx_1+1,1:ny-1,1:nz-1).*...
           (hy(2:npmlx_1+1,1:ny-1,1:nz-1)-hy(1:npmlx_1,1:ny-1,1:nz-1));
       
    ey(2:npmlx_1+1,1:ny-1,1:nz-1) = ey(2:npmlx_1+1,1:ny-1,1:nz-1)-...
     q_ey_xz_1(2:npmlx_1+1,1:ny-1,1:nz-1);
 
    ez(2:npmlx_1+1,1:ny-1,1:nz-1) = ez(2:npmlx_1+1,1:ny-1,1:nz-1)+...
     q_ez_xy_1(2:npmlx_1+1,1:ny-1,1:nz-1);
end

% upper x-pml region (XPlus):
if(npmlx_2 > 0)
    ns = nx - npmlx_2;
    q_ey_xz_2(1:npmlx_2,1:ny-1,1:nz-1)=...
    b_eyz_xz_2(1:npmlx_2,1:ny-1,1:nz-1).*q_ey_xz_2(1:npmlx_2,1:ny-1,1:nz-1)+...
     c_ey_xz_2(1:npmlx_2,1:ny-1,1:nz-1).*...
           (hz(ns:nx-1,1:ny-1,1:nz-1)-hz(ns-1:nx-2,1:ny-1,1:nz-1));
       
    q_ez_xy_2(1:npmlx_2,1:ny-1,1:nz-1) =...
    b_eyz_xz_2(1:npmlx_2,1:ny-1,1:nz-1).*q_ez_xy_2(1:npmlx_2,1:ny-1,1:nz-1)+...
     c_ez_xy_2(1:npmlx_2,1:ny-1,1:nz-1).*...
           (hy(ns:nx-1,1:ny-1,1:nz-1)-hy(ns-1:nx-2,1:ny-1,1:nz-1));
       
    ey(ns:nx-1,1:ny-1,1:nz-1) = ey(ns:nx-1,1:ny-1,1:nz-1)-...
     q_ey_xz_2(1:npmlx_2,1:ny-1,1:nz-1);
 
    ez(ns:nx-1,1:ny-1,1:nz-1) = ez(ns:nx-1,1:ny-1,1:nz-1)+...
     q_ez_xy_2(1:npmlx_2,1:ny-1,1:nz-1);
end

% lower y-pml region (YMinus):
if(npmly_1 > 0)
    q_ez_yx_1(1:nx-1,2:npmly_1+1,1:nz-1)=...
    b_ezx_yx_1(1:nx-1,2:npmly_1+1,1:nz-1).*q_ez_yx_1(1:nx-1,2:npmly_1+1,1:nz-1)+...
     c_ez_yx_1(1:nx-1,2:npmly_1+1,1:nz-1).*...
           (hx(1:nx-1,2:npmly_1+1,1:nz-1)-hx(1:nx-1,1:npmly_1,1:nz-1));
       
    q_ex_yz_1(1:nx-1,2:npmly_1+1,1:nz-1) =...
    b_ezx_yx_1(1:nx-1,2:npmly_1+1,1:nz-1).*q_ex_yz_1(1:nx-1,2:npmly_1+1,1:nz-1)+...
     c_ex_yz_1(1:nx-1,2:npmly_1+1,1:nz-1).*...
           (hz(1:nx-1,2:npmly_1+1,1:nz-1)-hz(1:nx-1,1:npmly_1,1:nz-1));
       
    ez(1:nx-1,2:npmly_1+1,1:nz-1) = ez(1:nx-1,2:npmly_1+1,1:nz-1)-...
     q_ez_yx_1(1:nx-1,2:npmly_1+1,1:nz-1);
 
    ex(1:nx-1,2:npmly_1+1,1:nz-1) = ex(1:nx-1,2:npmly_1+1,1:nz-1)+...
     q_ex_yz_1(1:nx-1,2:npmly_1+1,1:nz-1);
end

% upper y-pml region (YPlus):
if(npmly_2 > 0)
    ns = ny - npmly_2;
     q_ez_yx_2(1:nx-1,1:npmly_2,1:nz-1)=...
    b_ezx_yx_2(1:nx-1,1:npmly_2,1:nz-1).*q_ez_yx_2(1:nx-1,1:npmly_2,1:nz-1)+...
     c_ez_yx_2(1:nx-1,1:npmly_2,1:nz-1).*...
           (hx(1:nx-1,ns:ny-1,1:nz-1)-hx(1:nx-1,ns-1:ny-2,1:nz-1));
       
     q_ex_yz_2(1:nx-1,1:npmly_2,1:nz-1)=...
    b_ezx_yx_2(1:nx-1,1:npmly_2,1:nz-1).*q_ex_yz_2(1:nx-1,1:npmly_2,1:nz-1)+...
     c_ex_yz_2(1:nx-1,1:npmly_2,1:nz-1).*...
           (hz(1:nx-1,ns:ny-1,1:nz-1)-hz(1:nx-1,ns-1:ny-2,1:nz-1));
       
    ez(1:nx-1,ns:ny-1,1:nz-1) = ez(1:nx-1,ns:ny-1,1:nz-1)-...
     q_ez_yx_2(1:nx-1,1:npmly_2,1:nz-1);
 
    ex(1:nx-1,ns:ny-1,1:nz-1) = ex(1:nx-1,ns:ny-1,1:nz-1)+...
     q_ex_yz_2(1:nx-1,1:npmly_2,1:nz-1);
end

% lower z-pml region (ZMinus):
if(npmlz_1 > 0)
    q_ex_zy_1(1:nx-1,1:ny-1,2:npmlz_1+1)=...
    b_exy_zy_1(1:nx-1,1:ny-1,2:npmlz_1+1).*q_ex_zy_1(1:nx-1,1:ny-1,2:npmlz_1+1)+...
     c_ex_zy_1(1:nx-1,1:ny-1,2:npmlz_1+1).*...
           (hy(1:nx-1,1:ny-1,2:npmlz_1+1)-hy(1:nx-1,1:ny-1,1:npmlz_1));
       
    q_ey_zx_1(1:nx-1,1:ny-1,2:npmlz_1+1) =...
    b_exy_zy_1(1:nx-1,1:ny-1,2:npmlz_1+1).*q_ey_zx_1(1:nx-1,1:ny-1,2:npmlz_1+1)+...
     c_ey_zx_1(1:nx-1,1:ny-1,2:npmlz_1+1).*...
           (hx(1:nx-1,1:ny-1,2:npmlz_1+1)-hx(1:nx-1,1:ny-1,1:npmlz_1));
       
    ex(1:nx-1,1:ny-1,2:npmlz_1+1) = ex(1:nx-1,1:ny-1,2:npmlz_1+1)-...
     q_ex_zy_1(1:nx-1,1:ny-1,2:npmlz_1+1);
 
    ey(1:nx-1,1:ny-1,2:npmlz_1+1) = ey(1:nx-1,1:ny-1,2:npmlz_1+1)+...
     q_ey_zx_1(1:nx-1,1:ny-1,2:npmlz_1+1);
end

% upper z-pml region (ZPlus):
if(npmlz_2 > 0)
    ns = nz - npmlz_2;
     q_ex_zy_2(1:nx-1,1:ny-1,1:npmlz_2)=...
    b_exy_zy_2(1:nx-1,1:ny-1,1:npmlz_2).*q_ex_zy_2(1:nx-1,1:ny-1,1:npmlz_2)+...
     c_ex_zy_2(1:nx-1,1:ny-1,1:npmlz_2).*...
           (hy(1:nx-1,1:ny-1,ns:nz-1)-hy(1:nx-1,1:ny-1,ns-1:nz-2));
       
     q_ey_zx_2(1:nx-1,1:ny-1,1:npmlz_2)=...
    b_exy_zy_2(1:nx-1,1:ny-1,1:npmlz_2).*q_ey_zx_2(1:nx-1,1:ny-1,1:npmlz_2)+...
     c_ey_zx_2(1:nx-1,1:ny-1,1:npmlz_2).*...
           (hx(1:nx-1,1:ny-1,ns:nz-1)-hx(1:nx-1,1:ny-1,ns-1:nz-2));
       
    ex(1:nx-1,1:ny-1,ns:nz-1) = ex(1:nx-1,1:ny-1,ns:nz-1)-...
     q_ex_zy_2(1:nx-1,1:ny-1,1:npmlz_2);
 
    ey(1:nx-1,1:ny-1,ns:nz-1) = ey(1:nx-1,1:ny-1,ns:nz-1)+...
     q_ey_zx_2(1:nx-1,1:ny-1,1:npmlz_2);
end

